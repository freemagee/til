<!doctype html><html class=no-js lang=en-gb><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Update state from props in React | Front-end web development | Neil Magee</title><meta name=description content="How to use getDerivedStateFromProps for React form controls" property=og:description><meta name=keywords content><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Neil Magee"><meta name=referrer content=no-referrer-when-downgrade><link href=/images/favicon/favicon-16x16.png rel="shortcut icon" type=image/png><link rel=stylesheet href=/css/style-b662c601.css><link rel=stylesheet href=/css/code-highlighting-52395fdb.css></head><body><header class=site-header><section class=site-header__ident><a href=https://til.neilmagee.com/ class=site-header__link>TIL</a></section><nav class=site-header__nav><a href=/about class=site-header__nav-item>About</a></nav></header><div class=site-container><div class=site-container__inner><main role=main id=content><article class="post post--single" itemscope itemtype=http://schema.org/BlogPosting><header class=post__header><h1 class="post__title post__title--single" itemprop=title>Update state from props in React</h1><div class=post__meta><time class=post__date datetime=2019-01-08 itemprop="dateCreated pubdate datePublished"><span class=post__date-icon><svg id="Calendar" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20" enable-background="new 0 0 20 20"><path d="M17 3h-1v2h-3V3H7v2H4V3H3C1.899 3 1 3.9 1 5v12c0 1.1.899 2 2 2h14c1.1.0 2-.9 2-2V5C19 3.9 18.1 3 17 3zm0 14H3V9h14v8zM6.5 1h-2v3.5h2V1zm9 0h-2v3.5h2V1z" class="post__meta-icon" /></svg></span><span class=post__date-label>2019-01-08</span></time><div class=post__read-time><span class=post__read-time-icon><svg id="Stopwatch" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20" enable-background="new 0 0 20 20"><path d="M7.376 6.745c-.447.275 1.197 4.242 1.598 4.888.35.569 1.093.742 1.658.394.568-.352.745-1.094.395-1.66C10.63 9.719 7.822 6.469 7.376 6.745zM7.041 2.402C7.969 2.079 8.963 1.9 10 1.9s2.031.179 2.959.502c.329.114.765-.115.572-.611-.141-.36-.277-.712-.332-.855-.131-.339-.6-.619-.804-.665C11.623.097 10.823.0 10 0S8.377.097 7.604.271C7.4.317 6.932.597 6.801.936 6.746 1.079 6.609 1.431 6.469 1.791 6.276 2.287 6.712 2.517 7.041 2.402zM19.098 3.186c-.192-.23-.396-.455-.613-.672-.216-.217-.441-.42-.67-.613-.153-.129-.603-.234-.888.051-.284.285-1.648 1.647-1.648 1.647.402.288.793.605 1.155.966.362.361.677.752.966 1.155.0.0 1.363-1.362 1.647-1.647C19.333 3.787 19.228 3.338 19.098 3.186zM10 2.9c-4.475.0-8.101 3.626-8.101 8.1.0 4.475 3.626 8.101 8.101 8.101 4.473.0 8.1-3.626 8.1-8.101C18.1 6.527 14.473 2.9 10 2.9zM10 17.101c-3.368.0-6.1-2.731-6.1-6.1.0-3.369 2.731-6.1 6.1-6.1 3.369.0 6.101 2.731 6.101 6.1C16.101 14.369 13.369 17.101 10 17.101z" class="post__meta-icon" /></svg></span><span class=post__read-time-label>4 min read</span></div><ul class=post__categories><li class=post__category><a href=/categories/development class=post__category-link>development</a></li></ul></div></header><section class=post-content><p>Today I learned how to use a new(ish) React lifecycle hook called <code>getDerivedStateFromProps</code> (<a href=https://reactjs.org/blog/2018/03/27/update-on-async-rendering.html#updating-state-based-on-props>link</a>). I have struggled a little bit with form components that allow you to edit data. In my example below it is &ldquo;user&rdquo; data, but in reality this could affect all forms with any data in React.</p><h2 id=overview>Overview</h2><p>The reason for the struggle is a slight conflict for the one true source of the data for the form. When the &ldquo;user&rdquo; is edited, and the <strong>user form component</strong> is used, data is fed into it via props from it&rsquo;s <em>parent component</em>. So the Employer and Job title current values can appear in their relevant inputs.</p><p>That would be ok if that data was static, but the data is not and it needs to be editable. So the props are copied into the <strong>user form component</strong> state. And this state is used as the value of the relevant inputs. That allows the inputs to receive new data, which triggers off a chain of events.</p><p>The new data is processed via a <code>handleChange</code> event in the <strong>user form component</strong>. Two things happen, it is added to the current state and also passed to a <em>parent component</em> for other actions to happen. When that <em>parent component</em> is done, it sends that data back to this <strong>user form component</strong> as props and the cycle can continue.</p><h2 id=the-problem>The Problem</h2><p>I have two buttons that provide control for this form in another component (that is probably bad architecture, but it made sense at the time), Update User and Cancel. Update will eventually save the data back to the database. But Cancel will hide <strong>user form component</strong> and reset the user data back to it&rsquo;s original form in the <em>parent component</em>. This is where the problem can happen. Because <strong>user form component</strong> has it&rsquo;s own state, if a user edits the data, then cancels, then re-edits the data the <strong>previous</strong> edit would be visible.</p><p>I tried a combination of <code>shouldComponentUpdate</code> with <code>componentDidUpdate</code> to force <strong>user form component</strong> to change it&rsquo;s state based on newly changed parent props. But each time I had a bug. Either the component stopped rendering or I got infinite loops.</p><p>This probably means I don&rsquo;t fully understand what is happening and/or my app architecture has problems. I accept that. More to learn.</p><h2 id=the-solution>The Solution</h2><p>So for me, <code>getDerivedStateFromProps</code> is saying &ldquo;if the new props do not match the state then output a new state&rdquo;. It does seem like the <a href=https://reactjs.org/docs/react-component.html#static-getderivedstatefromprops>React documentation</a> is kind of recommending against this:</p><blockquote><p>If you want to “reset” some state when a prop changes, consider either making a component fully controlled or fully uncontrolled with a key instead.</p></blockquote><p>But it works. For now! I will explore the React docs suggestions for a better, more maintainable solution.</p><h2 id=user-form-component-complete>User Form Component - Complete</h2><pre><code class=language-javascript>import React from &quot;react&quot;;

export default class User extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      employer: this.props.user.employer,
      jobTitle: this.props.user.jobTitle
    };

    this.handleChange = this.handleChange.bind(this);
  }
  static getDerivedStateFromProps(nextProps, nextState) {
    if (
      nextProps.user.employer !== nextState.employer ||
      nextProps.user.jobTitle !== nextState.jobTitle
    ) {
      // The props have changed. So update state accordingly.
      return {
        employer: nextProps.user.employer,
        jobTitle: nextProps.user.jobTitle
      };
    }

    // Return null to indicate no change to state.
    return null;
  }
  handleChange(event) {
    const target = event.target;
    const value = target.value;
    const name = target.name;

    this.setState({
      [name]: value
    });

    // The following update the data in a parent component, which will eventually come back to this component via props.
    if (name === &quot;employer&quot;) {
      this.props.onEmployerUpdate(value);
    }

    if (name === &quot;jobTitle&quot;) {
      this.props.onJobTitleUpdate(value);
    }
  }
  render() {
    const employerClass =
      this.props.user.employer !== &quot;&quot;
        ? &quot;User__employer&quot;
        : &quot;User__employer is-invalid&quot;;
    const jobTitleClass =
      this.props.user.jobTitle !== &quot;&quot;
        ? &quot;User__jobTitle&quot;
        : &quot;User__jobTitle is-invalid&quot;;

    if (this.props.appMode === &quot;edit&quot;) {
      return (
        &lt;div className=&quot;User&quot;&gt;
          &lt;div className=&quot;User__control&quot;&gt;
            &lt;input
              className={employerClass}
              type=&quot;text&quot;
              value={this.state.employer}
              name=&quot;title&quot;
              onChange={this.handleChange}
            /&gt;
          &lt;/div&gt;
          &lt;div className=&quot;User__control&quot;&gt;
            &lt;input
              className={jobTitleClass}
              type=&quot;text&quot;
              value={this.state.jobTitle}
              name=&quot;content&quot;
              onChange={this.handleChange}
            /&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      );
    } else {
      return &lt;div className=&quot;User is-hidden&quot; /&gt;;
    }
  }
}

</code></pre></section><footer class=post__footer><ul class=post__tags><li class=post__tag><a href=/tags/react class=post__tag-link><span class=post__tag-label>#</span>react</a></li></ul></footer></article><aside class=post-siblings><nav class=post-siblings__ctrl><a class="post-siblings__nav post-siblings__nav--next" href=https://til.neilmagee.com/post/react-simplify-components/ rel=nofollow><span class=post-siblings__nav-icon><svg id="Chevron_left" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20" enable-background="new 0 0 20 20"><path d="M12.452 4.516c.446.436.481 1.043.0 1.576L8.705 10l3.747 3.908c.481.533.446 1.141.0 1.574-.445.436-1.197.408-1.615.0-.418-.406-4.502-4.695-4.502-4.695C6.112 10.57 6 10.285 6 10s.112-.57.335-.789c0 0 4.084-4.287 4.502-4.695C11.255 4.107 12.007 4.08 12.452 4.516z" class="post-siblings__nav-icon-next" /></svg></span>Next</a>
<a class="post-siblings__nav post-siblings__nav--previous" href=https://til.neilmagee.com/post/git-undo-commit/ rel=nofollow>Previous<span class=post-siblings__nav-icon><svg id="Chevron_right" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20" enable-background="new 0 0 20 20"><path d="M9.163 4.516c.418.408 4.502 4.695 4.502 4.695C13.888 9.43 14 9.715 14 10s-.112.57-.335.787c0 0-4.084 4.289-4.502 4.695-.418.408-1.17.436-1.615.0-.446-.434-.481-1.041.0-1.574L11.295 10 7.548 6.092c-.481-.533-.446-1.141.0-1.576C7.993 4.08 8.745 4.107 9.163 4.516z" class="post-siblings__nav-icon-previous" /></svg></span></a></nav><span class=post-siblings__more>More posts</span></aside></main><footer class=site-footer><div class=site-footer__inner><p class=site-footer__copyright>&copy; 2020&nbsp;<a href=https://neilmagee.com>Neil Magee</a>
. Icons from <a href=http://entypo.com>Entypo+</a>. Made with <a href=https://gohugo.io/ class=site-footer__hugo-logo><img src=/images/hugo-logo.png alt="Hugo logo" width=22 height=22></a></p></div></footer></div></div><script src=/js/highlight.pack.js></script><script>document.addEventListener("DOMContentLoaded",event=>{document.documentElement.classList.remove("no-js");document.querySelectorAll("pre:not(.chroma) code").forEach(block=>{hljs.highlightBlock(block);});});</script></body></html>