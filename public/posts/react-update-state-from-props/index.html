<!doctype html>
<html lang="en-gb">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>
  TIL
    -
  Update state from props in React
</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="author" content="Neil Magee">
  <meta name="referrer" content="no-referrer-when-downgrade">

  <link href="https://til.neilmagee.com/images/favicon/favicon-16x16.png" rel="shortcut icon" type="image/png">

  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,600,700" rel="stylesheet">
  <link rel="stylesheet" href="https://til.neilmagee.com/css/style.css" />
</head>
<body>
  

<header class="site-header">
  <section class="site-header__ident">
    <a href="https://til.neilmagee.com/" class="site-header__link">TIL</a>
  </section>
  <nav class="site-header__nav">
  
    <a href="https://til.neilmagee.com/about/" class="site-header__nav-item">About</a>
  
  </nav>
</header>
  <div class="site-container">
    <div class="site-container__inner">
      <main role="main">
        
  <article class="post post--single">
    <header class="post__header">
      <h1 class="post__title post__title--single">Update state from props in React</h1>
      <div class="post__meta">
        <time class="post__date" datetime="2019-01-08T11:11:05Z">
          <span class="post__published">Published:</span>
          <span class="post__published-value">2019-01-08</span>
        </time>
        
        <ul class="post__categories">
          
          <li class="post__category">
            <a href="https://til.neilmagee.com/categories/development/" class="post__category-link">development</a>
          </li>
          
        </ul>
        
      </div>
    </header>
    <section class="post-content">
      <p>Today I learned how to use a new(ish) React lifecycle hook called <code>getDerivedStateFromProps</code> (<a href="https://reactjs.org/blog/2018/03/27/update-on-async-rendering.html#updating-state-based-on-props">link</a>). I have struggled a little bit with form components that allow you to edit data. In my example below it is &ldquo;user&rdquo; data, but in reality this could affect all forms with any data in React.</p>

<h2 id="overview">Overview</h2>

<p>The reason for the struggle is a slight conflict for the one true source of the data for the form. When the &ldquo;user&rdquo; is edited, and the <strong>user form component</strong> is used, data is fed into it via props from it&rsquo;s <em>parent component</em>. So the Employer and Job title current values can appear in their relevant inputs.</p>

<p>That would be ok if that data was static, but the data is not and it needs to be editable. So the props are copied into the <strong>user form component</strong> state. And this state is used as the value of the relevant inputs. That allows the inputs to receive new data, which triggers off a chain of events.</p>

<p>The new data is processed via a <code>handleChange</code> event in the <strong>user form component</strong>. Two things happen, it is added to the current state and also passed to a <em>parent component</em> for other actions to happen. When that <em>parent component</em> is done, it sends that data back to this <strong>user form component</strong> as props and the cycle can continue.
</p>

<h2 id="the-problem">The Problem</h2>

<p>I have two buttons that provide control for this form in another component (that is probably bad architecture, but it made sense at the time), Update User and Cancel. Update will eventually save the data back to the database. But Cancel will hide <strong>user form component</strong> and reset the user data back to it&rsquo;s original form in the <em>parent component</em>. This is where the problem can happen. Because <strong>user form component</strong> has it&rsquo;s own state, if a user edits the data, then cancels, then re-edits the data the <strong>previous</strong> edit would be visible.</p>

<p>I tried a combination of <code>shouldComponentUpdate</code> with <code>componentDidUpdate</code> to force <strong>user form component</strong> to change it&rsquo;s state based on newly changed parent props. But each time I had a bug. Either the component stopped rendering or I got infinite loops.</p>

<p>This probably means I don&rsquo;t fully understand what is happening and/or my app architecture has problems. I accept that. More to learn.</p>

<h2 id="the-solution">The Solution</h2>

<p>So for me, <code>getDerivedStateFromProps</code> is saying &ldquo;if the new props do not match the state then output a new state&rdquo;. It does seem like the <a href="https://reactjs.org/docs/react-component.html#static-getderivedstatefromprops">React documentation</a> is kind of recommending against this:</p>

<blockquote>
<p>If you want to “reset” some state when a prop changes, consider either making a component fully controlled or fully uncontrolled with a key instead.</p>
</blockquote>

<p>But it works. For now! I will explore the React docs suggestions for a better, more maintainable solution.</p>

<h2 id="user-form-component-complete">User Form Component - Complete</h2>

<pre><code class="language-javascript">import React from &quot;react&quot;;

export default class User extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      employer: this.props.user.employer,
      jobTitle: this.props.user.jobTitle
    };

    this.handleChange = this.handleChange.bind(this);
  }
  static getDerivedStateFromProps(nextProps, nextState) {
    if (
      nextProps.user.employer !== nextState.employer ||
      nextProps.user.jobTitle !== nextState.jobTitle
    ) {
      // The props have changed. So update state accordingly.
      return {
        employer: nextProps.user.employer,
        jobTitle: nextProps.user.jobTitle
      };
    }

    // Return null to indicate no change to state.
    return null;
  }
  handleChange(event) {
    const target = event.target;
    const value = target.value;
    const name = target.name;

    this.setState({
      [name]: value
    });

    // The following update the data in a parent component, which will eventually come back to this component via props.
    if (name === &quot;employer&quot;) {
      this.props.onEmployerUpdate(value);
    }

    if (name === &quot;jobTitle&quot;) {
      this.props.onJobTitleUpdate(value);
    }
  }
  render() {
    const employerClass =
      this.props.user.employer !== &quot;&quot;
        ? &quot;User__employer&quot;
        : &quot;User__employer is-invalid&quot;;
    const jobTitleClass =
      this.props.user.jobTitle !== &quot;&quot;
        ? &quot;User__jobTitle&quot;
        : &quot;User__jobTitle is-invalid&quot;;

    if (this.props.appMode === &quot;edit&quot;) {
      return (
        &lt;div className=&quot;User&quot;&gt;
          &lt;div className=&quot;User__control&quot;&gt;
            &lt;input
              className={employerClass}
              type=&quot;text&quot;
              value={this.state.employer}
              name=&quot;title&quot;
              onChange={this.handleChange}
            /&gt;
          &lt;/div&gt;
          &lt;div className=&quot;User__control&quot;&gt;
            &lt;input
              className={jobTitleClass}
              type=&quot;text&quot;
              value={this.state.jobTitle}
              name=&quot;content&quot;
              onChange={this.handleChange}
            /&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      );
    } else {
      return &lt;div className=&quot;User is-hidden&quot; /&gt;;
    }
  }
}

</code></pre>
    </section>
    <footer class="post__footer">
      
      <ul class="post__tags">
        
        <li class="post__tag"><a href="https://til.neilmagee.com/tags/react/" class="post__tag-link"><span class="post__tag-label">#</span>react</a></li>
        
      </ul>
      
    </footer>
  </article>

  

      </main>
      <footer class="site-footer">
        <div class="site-footer__inner">
          <p class="site-footer__copyright">&copy; 2019 <a href="http://neilmagee.com">Neil Magee</a>. Icons from <a href="http://entypo.com">Entypo+</a>. Made with <a href="https://gohugo.io/" class="site-footer__hugo-logo"><img src="/images/hugo-logo.png" alt="Hugo logo" width="22" height="22"></a></p>
        </div>
      </footer>
    </div>
  </div>
</body>
</html>